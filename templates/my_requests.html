{% extends "base.html" %}

{% block title %}–ú–æ–∏ –∑–∞—è–≤–∫–∏{% endblock %}

{% block content %}
<h1 style="text-align: center; font-family: 'Kaushan Script', cursive; margin-bottom: 20px;">–ú–æ–∏ –∑–∞—è–≤–∫–∏</h1>

<div id="request-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
    {% for z in zayavki %}
    <div class="card {% if z.urgent %}urgent{% endif %}" id="request-card-{{ z.id }}">
        <h3>{{ z.type }}</h3>
        <p>{{ z.description }}</p>
        <p><strong>–î–∞—Ç–∞:</strong> {{ z.created_at.strftime('%d.%m.%Y %H:%M') }}</p>
        <p><strong>–°—Ç–∞—Ç—É—Å:</strong>
            {% if z.status == '—Å–¥–µ–ª–∞–Ω–æ' %}
            <span style="color: green;">–°–¥–µ–ª–∞–Ω–æ ‚úÖ</span>
            {% elif z.status == '–æ–∂–∏–¥–∞–µ—Ç' %}
            <span style="color: orange;">–û–∂–∏–¥–∞–µ—Ç üü°</span>
            {% elif z.status == '–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ' %}
            <span style="color: red;">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ üî¥</span>
            {% else %}
            <span style="color: gray;">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>
            {% endif %}
        </p>
        <p><strong>–§–∞–π–ª:</strong>
            {% if z.file %}
            <a href="{{ url_for('uploaded_file', filename=z.file) }}" target="_blank" style="color: #007bff;">–°–∫–∞—á–∞—Ç—å</a>
            {% else %}
            <span style="color: #555;">–ù–µ—Ç —Ñ–∞–π–ª–∞</span>
            {% endif %}
        </p>
        {% if z.status in ['—Å–¥–µ–ª–∞–Ω–æ', '–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ'] %}
        <form method="POST" action="{{ url_for('submit_feedback', request_id=z.id) }}">
            <textarea name="comment" rows="2" class="styled-textarea" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–∑—ã–≤..." required></textarea>
            <div class="rating">
                <input type="radio" id="star5-{{ z.id }}" name="rating" value="5" required><label for="star5-{{ z.id }}">‚òÖ</label>
                <input type="radio" id="star4-{{ z.id }}" name="rating" value="4"><label for="star4-{{ z.id }}">‚òÖ</label>
                <input type="radio" id="star3-{{ z.id }}" name="rating" value="3"><label for="star3-{{ z.id }}">‚òÖ</label>
                <input type="radio" id="star2-{{ z.id }}" name="rating" value="2"><label for="star2-{{ z.id }}">‚òÖ</label>
                <input type="radio" id="star1-{{ z.id }}" name="rating" value="1"><label for="star1-{{ z.id }}">‚òÖ</label>
            </div>
            <button type="submit" class="btn styled-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
        </form>
        {% endif %}
        {% if z.status != '—Å–¥–µ–ª–∞–Ω–æ' %}
        <button class="btn styled-btn delete-btn" data-request-id="{{ z.id }}" style="background: #e74a3b;">–£–¥–∞–ª–∏—Ç—å</button>
        {% endif %}
    </div>
    {% endfor %}
</div>

<style>
    @media (max-width: 768px) {
        .card {
            padding: 10px;
            font-size: 14px;
        }
    }
</style>

<div id="delete-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center;">
    <div class="modal-content" style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.3); text-align: center; width: 300px;">
        <p style="margin-bottom: 20px;">–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?</p>
        <form id="delete-form" method="POST">
            <button type="submit" class="btn styled-btn" style="background: #e74a3b; margin-right: 10px;">–£–¥–∞–ª–∏—Ç—å</button>
            <button type="button" class="btn styled-btn cancel-btn" style="background: #858796;">–û—Ç–º–µ–Ω–∞</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const deleteButtons = document.querySelectorAll('.delete-btn');
        const modal = document.getElementById('delete-modal');
        const deleteForm = document.getElementById('delete-form');
        const cancelBtn = document.querySelector('.cancel-btn');

        deleteButtons.forEach(button => {
            button.addEventListener('click', function () {
                const requestId = this.getAttribute('data-request-id');
                deleteForm.action = `/delete_request/${requestId}`;
                deleteForm.dataset.requestId = requestId;
                modal.style.display = 'flex';
            });
        });

        deleteForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const requestId = deleteForm.dataset.requestId;
            const card = document.getElementById(`request-card-${requestId}`);
            card.style.opacity = '0';
            setTimeout(() => {
                card.remove();
                modal.style.display = 'none';
                fetch(deleteForm.action, { method: 'POST' });
            }, 500);
        });

        cancelBtn.addEventListener('click', function () {
            modal.style.display = 'none';
        });
    });
</script>
{% endblock %}

